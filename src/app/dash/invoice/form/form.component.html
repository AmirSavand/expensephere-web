<div class="container py-3">

  <!-- Header -->
  <div class="fw-bold d-flex align-items-center mb-3" *ngIf="!notFound">

    <!-- Page title -->
    <a class="text-secondary" routerLink="../list">Invoices</a>
    <fa-icon [fixedWidth]="true" [icon]="faBreadcrumbArrow" class="small mx-1 text-secondary"></fa-icon>
    <span [class.text-monospace]="form.id">{{ form.id ? form.data?.invoice_id : 'Add' }}</span>

    <!-- Badges -->
    <div class="ms-auto" *ngIf="form.data">
      <div class="ms-auto badge bg-secondary badge-pill px-3 me-2">
        Subtotal {{ form.data.subtotal | profileCurrency:currency }}
      </div>
      <div class="ms-auto badge bg-info badge-pill px-3">
        Total {{ form.data.total | profileCurrency:currency }}
      </div>
    </div>
  </div>

  <!-- Loading -->
  <app-loading *ngIf="!notFound && form.id && !form.data"></app-loading>

  <!-- Not found -->
  <app-not-found name="Invoice" *ngIf="notFound"></app-not-found>

  <!-- Form -->
  <form *ngIf="!notFound" [formGroup]="form.form" (ngSubmit)="submit()">

    <!-- Row 1 -->
    <div class="row">

      <!-- Information -->
      <div class="col-xl-4 mb-3">
        <mat-card class="h-100">
          <mat-card-title class="fw-">Information</mat-card-title>
          <mat-card-content class="pb-0">

            <!-- Invoice ID -->
            <div class="mb-3 mt-3">
              <mat-form-field class="w-100">
                <mat-label>Invoice ID</mat-label>
                <input matInput
                       type="text"
                       formControlName="invoice_id"
                       placeholder="Invoice ID">
                <mat-error *ngIf="form.error.invoice_id">
                  {{ form.error.invoice_id[0] }}
                </mat-error>
              </mat-form-field>
            </div>

            <!-- Company -->
            <div class="form-group">
              <label for="company">Company</label>
              <app-select (add)="addContact('company')"
                          (choose)="form.form.get('company').setValue($event.id)"
                          [items]="contacts"
                          [selectedId]="form.form.get('company').value"
                          [showAdd]="true"
                          id="company"
                          selectLabel="Select company">
              </app-select>
              <div class="invalid-tooltip" *ngIf="form.error.company">{{ form.error.company[0] }}</div>
            </div>

            <!-- Client -->
            <div class="form-group">
              <label for="client">Client</label>
              <app-select (add)="addContact('client')"
                          (choose)="form.form.get('client').setValue($event.id)"
                          [items]="contacts"
                          [selectedId]="form.form.get('client').value"
                          [showAdd]="true"
                          id="client"
                          selectLabel="Select client">
              </app-select>
              <div class="invalid-tooltip" *ngIf="form.error.client">{{ form.error.client[0] }}</div>
            </div>

            <!-- Note -->
            <mat-form-field class="w-100 mt-3" *ngIf="options.get('note').value">
              <mat-label>Note</mat-label>
              <textarea matInput [rows]="4"
                        formControlName="note"
                        placeholder="Write a note">

              </textarea>
              <mat-error *ngIf="form.error.note">
                {{ form.error.note[0] }}
              </mat-error>
            </mat-form-field>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Payment -->
      <div class="col-xl-4 mb-3">
        <mat-card class="h-100">
          <mat-card-title>Payment</mat-card-title>
          <mat-card-content class="pb-0">

            <!-- Date -->
            <div class="mb-3 mt-3">
              <mat-form-field class="w-100" *ngIf="options.get('date').value">
                <mat-label>Date</mat-label>
                <input matInput
                       type="date"
                       formControlName="date">
                <mat-error *ngIf="form.error.date">
                  {{ form.error.date[0] }}
                </mat-error>
              </mat-form-field>
            </div>

            <!-- Due date -->
            <div class="mb-3">
              <mat-form-field class="w-100" *ngIf="options.get('due_date').value">
                <mat-label>Due Date</mat-label>
                <input matInput
                       type="date"
                       formControlName="due_date">
                <mat-error *ngIf="form.error.due_date">
                  {{ form.error.due_date[0] }}
                </mat-error>
              </mat-form-field>
            </div>

            <!-- Discount and discount type -->
            <div class="mb-3">
              <mat-form-field class="w-100" *ngIf="options.get('discount').value">
                <mat-label>Discount</mat-label>
                <div class="input-select-container">
                  <input matInput
                         type="number"
                         formControlName="discount"
                         placeholder="Enter discount"
                         [step]="1"
                         [min]="0"
                         [max]="100">
                  <mat-select formControlName="discount_flat">
                    <mat-option [value]="true">Flat</mat-option>
                    <mat-option [value]="false">Percentage</mat-option>
                  </mat-select>
                  <mat-error *ngIf="form.error.discount">
                    {{ form.error.discount[0] }}
                  </mat-error>
                </div>
              </mat-form-field>
            </div>

            <!-- Tax -->
            <mat-form-field class="w-100" *ngIf="options.get('tax').value">
              <mat-label>Tax</mat-label>
              <input matInput
                     placeholder="Enter tax (percentage)"
                     formControlName="tax"
                     autocomplete="off"
                     type="number"
                     [step]="1"
                     [min]="0"
                     [max]="100">
              <mat-error *ngIf="form.error.tax">
                {{ form.error.tax[0] }}
              </mat-error>
            </mat-form-field>

            <!-- Currency -->
            <div class="form-group">
              <label for="currency">Currency</label>
              <app-select id="currency"
                          selectLabel="Select currency"
                          *ngIf="currencies"
                          [items]="currencies"
                          [selectedId]="form.form.get('currency').value"
                          (choose)="form.form.get('currency').setValue($event.id)">
              </app-select>
              <div class="invalid-tooltip" *ngIf="form.error.currency">{{ form.error.currency[0] }}</div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Options -->
      <div class="col-xl-4 mb-3 order-first order-xl-last">
        <mat-card class="h-100">
          <mat-card-title>Options</mat-card-title>
          <mat-card-content class="pb-0">

            <!-- Template -->
            <div class="form-group border-bottom pb-3 mb-3">
              <label for="currency" class="d-flex align-items-center">
                <span>Template</span>
                <small class="ms-auto">More templates coming soon ðŸ˜‰</small>
              </label>
              <app-select id="template"
                          selectLabel="Select template"
                          [items]="templates"
                          [selectedId]="form.form.get('template').value"
                          (choose)="form.form.get('template').setValue($event.id)">
              </app-select>
              <div class="invalid-tooltip" *ngIf="form.error.template">{{ form.error.template[0] }}</div>
            </div>

            <!-- UI Options -->
            <div class="pb-3 mb-3 border-bottom" [formGroup]="options">

              <!-- Title -->
              <p>Click to toggle invoice options.</p>

              <!-- Discount -->
              <div>
                <mat-slide-toggle formControlName="discount">Discount</mat-slide-toggle>
              </div>

              <!-- Tax -->
              <div>
                <mat-slide-toggle formControlName="tax">Tax</mat-slide-toggle>
              </div>

              <!-- Payment status (is_paid) -->
              <div>
                <mat-slide-toggle formControlName="is_paid">Payment Status</mat-slide-toggle>
              </div>

              <!-- Date -->
              <div>
                <mat-slide-toggle formControlName="date">Date</mat-slide-toggle>
              </div>

              <!-- Due date -->
              <div>
                <mat-slide-toggle formControlName="due_date">Due Date</mat-slide-toggle>
              </div>

              <!-- Note -->
              <div>
                <mat-slide-toggle formControlName="note">Note</mat-slide-toggle>
              </div>

              <!-- Items label -->
              <div>
                <mat-slide-toggle formControlName="items_label">Items Label</mat-slide-toggle>
              </div>
            </div>

            <!-- Publish -->
            <div>
              <mat-slide-toggle formControlName="is_published">Allow access to direct link</mat-slide-toggle>
            </div>

            <!-- Paid -->
            <div>
              <mat-slide-toggle formControlName="is_paid"
                                *ngIf="options.get('is_paid').value">
                Is invoice paid by client
              </mat-slide-toggle>
            </div>

            <!-- Items label -->
            <div class="mt-3">
            <mat-form-field class="w-100" *ngIf="options.get('items_label').value">
              <mat-label>Items Label</mat-label>
              <input matInput
                     formControlName="items_label"
                     placeholder="Label for the items/products/services">
              <mat-error *ngIf="form.error.items_label">
                {{ form.error.items_label[0] }}
              </mat-error>
              </mat-form-field>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </div>

    <!-- Items -->
    <mat-card class="mb-3">
      <mat-card-title>{{ form.form.get('items_label').value || "Items" }}</mat-card-title>
      <mat-card-content>

          <!-- Invoice items table -->
          <table class="table table-borderless" *ngIf="itemForms.length">
            <thead>
            <tr>
              <th>Description</th>
              <th>Quantity</th>
              <th>Price</th>
              <th class="text-end">Total</th>
              <th></th>
            </tr>
            </thead>
            <tbody>
            <!-- Invoice item row -->
            <tr *ngFor="let item of itemForms; let index = index" [formGroup]="item.form">
              <!-- Description -->
              <td>
                <mat-form-field class="w-100">
                <input matInput
                       type="text"
                       formControlName="description">
                  <mat-error *ngIf="form.error.description">
                    {{ form.error.description[0] }}
                  </mat-error>
                </mat-form-field>
              </td>
              <!-- Quantity -->
              <td>
                <mat-form-field class="w-100">
                <input matInput
                       type="number"
                       min="0"
                       formControlName="quantity">
                <mat-error *ngIf="form.error.quantity">
                  {{ form.error.quantity[0] }}
                </mat-error>
                </mat-form-field>
              </td>
              <!-- Price -->
              <td>
                <mat-form-field class="w-100">
                <input matInput
                       type="number"
                       formControlName="price">
                  <mat-error *ngIf="form.error.price">
                    {{ form.error.price[0] }}
                  </mat-error>
                </mat-form-field>
              </td>
              <!-- Total -->
              <td class="text-end">
                <div class="pt-2 ps-2 pb-0 pe-0">
                  {{ (item.data.amount || 0) | profileCurrency:currency }}
                </div>
              </td>
              <!-- Delete -->
              <td class="text-end">
                <a class="pt-2 ps-2 pb-0 pe-0 d-block text-danger" (click)="removeItem(item)">
                  <fa-icon [fixedWidth]="true" [icon]="faDelete"></fa-icon>
                </a>
              </td>
            </tr>
            </tbody>
          </table>

          <!-- No invoice items message -->
        <mat-card-subtitle *ngIf="!itemForms.length">
          There are no invoice items. Click to add new ones ðŸš€
        </mat-card-subtitle>

          <!-- Add a new invoice item form to the list -->
          <button mat-flat-button type="button" class="btn btn-success" (click)="addItemForm()">
            <fa-icon [fixedWidth]="true" [icon]="faAdd"></fa-icon>
            Add a new item
          </button>
      </mat-card-content>
    </mat-card>

    <!-- Error -->
    <app-general-error [form]="form"></app-general-error>

    <!-- Buttons -->
    <div class="d-flex align-items-center mt-3">
      <button type="button" class="btn btn-danger" (click)="remove()" *ngIf="form.id">
        <fa-icon [icon]="faDelete" [fixedWidth]="true"></fa-icon>
      </button>
      <button mat-button type="button" class="ms-auto" routerLink="../list">
        {{ form.id ? 'Cancel' : 'Go Back' }}
      </button>
      <button mat-flat-button class="btn btn-primary ms-2"
              (click)="submit()"
              [disabled]="form.loading">
        {{ form.id ? 'Update' : 'Add' }}
      </button>
    </div>
  </form>
</div>
