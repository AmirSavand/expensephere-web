<!-- Header -->
<div class="modal-header">

  <!-- Title -->
  <span>{{ isEditing ? 'Edit' : 'New' }} Transaction</span>

  <!-- Close -->
  <button mat-button (click)="modal.hide()" class="text-secondary">
    <fa-icon [fixedWidth]="true" [icon]="faClose"></fa-icon>
  </button>
</div>

<!-- Body -->
<div *ngIf="!noWallets" class="modal-body pb-0">
  <form (ngSubmit)="submit()" *ngIf="form.form" [formGroup]="form.form">

    <!-- Kind -->
    <div class="mb-4">
      <mat-button-toggle-group name="fontStyle" class="w-100" appearance="legacy">
        <mat-button-toggle class="btn py-0 fw-bold income-style"
                           (click)="setExpenseKind(expenseKind.INCOME)"
                           [class.btn-light]="expenseKindSelected !== expenseKind.INCOME"
                           [class.btn-primary]="expenseKindSelected === expenseKind.INCOME">INCOME
        </mat-button-toggle>
        <mat-button-toggle class="btn py-0 fw-bold w-100"
                           (click)="setExpenseKind(expenseKind.EXPENSE)"
                           [class.btn-danger]="expenseKindSelected === expenseKind.EXPENSE"
                           [class.btn-light]="expenseKindSelected !== expenseKind.EXPENSE"
                           [checked]="true">EXPENSE
        </mat-button-toggle>
        <mat-button-toggle class="btn py-0 fw-bold w-100"
                           (click)="setExpenseKind(expenseKind.TRANSFER)"
                           [class.btn-light]="expenseKindSelected !== expenseKind.TRANSFER"
                           [class.btn-secondary]="expenseKindSelected === expenseKind.TRANSFER">Transfer
        </mat-button-toggle>
      </mat-button-toggle-group>
    </div>


    <!-- Wallet -->
    <div class="form-group">
      <label for="wallet">Wallet</label>
      <div class="input-group">
        <div class="input-group-text">
          <fa-icon [fixedWidth]="true" [icon]="faWallet" class="input-group-text"></fa-icon>
        </div>
        <app-select (add)="addWallet()"
                    (choose)="form.form.get('wallet').setValue($event.id); walletInlineStorage.value = $event.id"
                    [items]="wallets"
                    [selectedId]="form.form.get('wallet').value"
                    [showAdd]="true"
                    id="wallet"
                    selectLabel="Select wallet">
        </app-select>
        <div *ngIf="form.error.wallet" class="invalid-tooltip">{{ form.error.wallet[0] }}</div>
      </div>
    </div>

    <!-- Into (wallet) -->
    <div *ngIf="expenseKindSelected === expenseKind.TRANSFER" class="form-group">
      <label for="into">Into Wallet</label>
      <div class="input-group">
        <div class="input-group-text">
          <fa-icon [fixedWidth]="true" [icon]="faWallet" class="input-group-text"></fa-icon>
        </div>
        <app-select (choose)="form.form.get('into').setValue($event.id)"
                    [items]="wallets"
                    [selectedId]="form.form.get('into').value"
                    id="into"
                    selectLabel="Select wallet to transfer into">
        </app-select>
        <div *ngIf="form.error.into" class="invalid-tooltip">{{ form.error.into[0] }}</div>
      </div>
    </div>

    <!-- Category -->
    <div *ngIf="expenseKindSelected !== expenseKind.TRANSFER" class="form-group">
      <label for="category">Category</label>
      <div class="input-group">
        <div class="input-group-text">
          <fa-icon [fixedWidth]="true" [icon]="faCategory" class="input-group-text"></fa-icon>
        </div>
        <app-select (add)="addCategory()"
                    (choose)="form.form.get('category').setValue($event.id)"
                    *ngIf="categories"
                    [items]="categoryGroups[expenseKindSelected]"
                    [selectedId]="form.form.get('category').value"
                    [showAdd]="true"
                    id="category"
                    selectLabel="Select category">
        </app-select>
        <div *ngIf="form.error.category" class="invalid-tooltip">{{ form.error.category[0] }}</div>
      </div>
    </div>

    <!-- Tags -->
    <div class="form-group">
      <label for="tags">Tags</label>
      <div class="input-group">
        <div class="input-group-text">
          <fa-icon [fixedWidth]="true" [icon]="faTag" class="input-group-text"></fa-icon>
        </div>
        <app-select (add)="addTag()"
                    (choose)="onTagSelect($event.id)"
                    (clear)="form.form.patchValue({ tags:[] })"
                    *ngIf="categories"
                    [allowClear]="true"
                    [items]="tags"
                    [showAdd]="true"
                    [showSelected]="false"
                    id="tags"
                    selectLabel="Select tags">
        </app-select>
        <div *ngIf="form.error.category" class="invalid-tooltip">{{ form.error.tags[0] }}</div>
      </div>
      <div *ngIf="form.form && tagsDict" class="tags-preview">
        <a (click)="onTagSelect(tag)"
           *ngFor="let tag of form.form.value['tags']"
           class="badge bg-secondary me-1 mt-1 py-2 py-lg-1"
           title="Click to remove">
          {{ tagsDict[tag].name }}
        </a>
      </div>
    </div>

    <!-- Amount -->
      <label class="label2">Amount</label>
      <mat-form-field class="w-100" appearance="fill">
        <mat-label>Initial Balance</mat-label>
        <span matPrefix class="icon-prefix">
          <fa-icon class="fa-lg" [fixedWidth]="true" [icon]="faAmount"></fa-icon>
        </span>
        <input matInput
               [class.is-invalid]="form.error.amount"
               [min]="0"
               [step]="1"
               autocomplete="off"
               formControlName="amount"
               id="amount"
               placeholder="Enter amount"
               type="number">
        <span matSuffix class="currency-suffix"><span class="fw-bold">{{ currency }}</span></span>
        <mat-error *ngIf="form.error.amount" class="invalid-tooltip">{{ form.error.amount[0] }}</mat-error>
      </mat-form-field>

    <!-- Time -->
    <label class="label2">Time</label>
    <mat-form-field class="w-100" appearance="fill">
      <mat-label>Select date</mat-label>
      <span matPrefix class="icon-prefix">
          <fa-icon class="fa-lg" [fixedWidth]="true" [icon]="faTime"></fa-icon>
        </span>
      <input matInput
             [class.is-invalid]="form.error.time"
             formControlName="time"
             id="time"
             type="datetime-local">
      <mat-error *ngIf="form.error.time" class="invalid-tooltip">{{ form.error.time[0] }}</mat-error>
    </mat-form-field>

    <!-- Extra details toggle -->
    <a (click)="showExtraDetails = !showExtraDetails"
       class="d-block fw-bold text-secondary mt-5 mb-3 text-uppercase">
      <span>Extra Details</span>
      <fa-icon [flip]="showExtraDetails ? 'vertical' : null" [icon]="faCollapse" class="float-end"></fa-icon>
    </a>

    <!-- Extra details -->
    <div [collapse]="!showExtraDetails">

      <!-- Event -->
      <div class="form-group">
        <label for="event">Event</label>
        <div class="input-group">
          <div class="input-group-text">
            <fa-icon [fixedWidth]="true" [icon]="faEvent" class="input-group-text"></fa-icon>
          </div>
          <app-select (add)="addEvent()"
                      (choose)="form.form.get('event').setValue($event.id)"
                      (clear)="form.form.get('event').reset()"
                      [allowClear]="true"
                      [items]="events"
                      [selectedId]="form.form.get('event').value"
                      [showAdd]="true"
                      id="event"
                      selectLabel="Select event">
          </app-select>
          <div *ngIf="form.error.event" class="invalid-tooltip">{{ form.error.event[0] }}</div>
        </div>
      </div>

      <!-- Note -->
      <label class="label2">Note</label>
      <mat-form-field class="w-100" appearance="fill">
        <mat-label>Write a note</mat-label>
        <span matPrefix class="note-prefix">
          <fa-icon class="fa-lg" [fixedWidth]="true" [icon]="faNote"></fa-icon>
        </span>
        <textarea matInput
                  [class.is-invalid]="form.error.note"
                  [rows]="3"
                  formControlName="note"
                  id="note"></textarea>
        <mat-error *ngIf="form.error.note" class="invalid-tooltip">{{ form.error.note[0] }}</mat-error>
      </mat-form-field>

      <!-- Archive -->
      <div class="form-group">
        <label for="archive">Archive</label>
        <div>
          <mat-slide-toggle formControlName="archive"
                            id="archive"
                            class="small">
            Archive and hide from the list
          </mat-slide-toggle>
        </div>
      </div>

      <!-- Exclude -->
      <div class="form-group">
        <label for="archive">Exclude</label>
        <div>
          <mat-slide-toggle formControlName="exclude"
                            id="exclude"
                            class="small">Exclude from the reports
          </mat-slide-toggle>
        </div>
      </div>
    </div>
  </form>
</div>

<!-- Footer -->
<div *ngIf="!noWallets" class="modal-footer text-end">

  <!-- Delete -->
  <a (click)="delete(transaction)" *ngIf="isEditing" class="text-danger me-auto">
    <fa-icon [fixedWidth]="true" [icon]="faTrash"></fa-icon>
  </a>

  <!-- Cancel -->
  <button mat-button (click)="modal.hide()">Cancel</button>

  <!-- Submit -->
  <button mat-flat-button (click)="submit()" [disabled]="form.loading || form.form.invalid">
    {{ isEditing ? 'Update' : 'Done' }}
  </button>
</div>

<!-- Body (when no wallets) -->
<div *ngIf="noWallets" class="modal-body">
  <p class="fw-bold text-warning">No Wallets ðŸ˜®</p>
  <p>You don't have any wallets for your profile.</p>
  <button (click)="addWallet(); modal.hide();" class="btn btn-primary">Add Wallet</button>
</div>
